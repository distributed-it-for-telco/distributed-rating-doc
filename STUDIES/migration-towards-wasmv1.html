<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Wasm v1 migration - Distributed Rating Engine with wasmCloud</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../about.html">About</a></li><li class="chapter-item expanded affix "><li class="part-title">Concepts</li><li class="chapter-item expanded "><a href="../CONCEPTS/concepts.html"><strong aria-hidden="true">1.</strong> Concepts</a></li><li class="chapter-item expanded affix "><li class="part-title">Architecture</li><li class="chapter-item expanded "><a href="../ARCHITECTURE/architecture.html"><strong aria-hidden="true">2.</strong> Software Architecture</a></li><li class="chapter-item expanded "><a href="../ARCHITECTURE/functional-specification.html"><strong aria-hidden="true">3.</strong> Functional Specification</a></li><li class="chapter-item expanded affix "><li class="part-title">Use Cases</li><li class="chapter-item expanded "><a href="../USE-CASES/UC-01/index.html"><strong aria-hidden="true">4.</strong> UC-01: Customer product inventory</a></li><li class="chapter-item expanded "><a href="../USE-CASES/UC-02/index.html"><strong aria-hidden="true">5.</strong> UC-02: Rate usage - Overview</a></li><li class="chapter-item expanded "><a href="../USE-CASES/UC-03/index.html"><strong aria-hidden="true">6.</strong> UC-03: Rate usage - Regular</a></li><li class="chapter-item expanded "><a href="../USE-CASES/UC-04/index.html"><strong aria-hidden="true">7.</strong> UC-04: Rate usage - Threshold</a></li><li class="chapter-item expanded "><a href="../USE-CASES/UC-05/index.html"><strong aria-hidden="true">8.</strong> UC-05: Rate usage - Bundle</a></li><li class="chapter-item expanded "><a href="../USE-CASES/UC-06/index.html"><strong aria-hidden="true">9.</strong> UC-06: CQRS - Usage Proof</a></li><li class="chapter-item expanded "><a href="../USE-CASES/UC-07/index.html"><strong aria-hidden="true">10.</strong> UC-07: Rate usage - MetaVerse</a></li><li class="chapter-item expanded affix "><li class="part-title">Architecture decision records</li><li class="chapter-item expanded "><a href="../ADR/ard001-monorepo_code_organization.html"><strong aria-hidden="true">11.</strong> Monorepo code organization</a></li><li class="chapter-item expanded affix "><li class="part-title">Studies</li><li class="chapter-item expanded "><a href="../STUDIES/migration-towards-wasmv1.html" class="active"><strong aria-hidden="true">12.</strong> Wasm v1 migration</a></li><li class="chapter-item expanded affix "><li class="part-title">How-to</li><li class="chapter-item expanded "><a href="../HOW-TO/kickstart.html"><strong aria-hidden="true">13.</strong> WasmCloud Kickstart</a></li><li class="chapter-item expanded "><a href="../HOW-TO/smithy-notes.html"><strong aria-hidden="true">14.</strong> Smithy</a></li><li class="chapter-item expanded affix "><li class="part-title">Handbook</li><li class="chapter-item expanded "><a href="../HANDBOOK/kv-store-management.html"><strong aria-hidden="true">15.</strong> Key-Value store management</a></li><li class="chapter-item expanded "><a href="../HANDBOOK/link-management.html"><strong aria-hidden="true">16.</strong> Link management</a></li><li class="chapter-item expanded "><a href="../HANDBOOK/shutdown-host.html"><strong aria-hidden="true">17.</strong> Shutdown host</a></li><li class="chapter-item expanded affix "><li class="part-title">Archives</li><li class="chapter-item expanded "><a href="../ARCHIVE/rationale.html"><strong aria-hidden="true">18.</strong> Rationale</a></li><li class="chapter-item expanded "><a href="../ARCHIVE/requirements.html"><strong aria-hidden="true">19.</strong> Requirements</a></li><li class="chapter-item expanded "><a href="../ARCHIVE/model.html"><strong aria-hidden="true">20.</strong> Model</a></li><li class="chapter-item expanded "><a href="../ARCHIVE/model-solution1.html"><strong aria-hidden="true">21.</strong> Solution 1</a></li><li class="chapter-item expanded "><a href="../ARCHIVE/about-wasmcloud.html"><strong aria-hidden="true">22.</strong> About wasmCloud</a></li><li class="chapter-item expanded "><a href="../ARCHIVE/architecture.html"><strong aria-hidden="true">23.</strong> wasmCloud Architecture</a></li><li class="chapter-item expanded "><a href="../ARCHIVE/prototype-architecture.html"><strong aria-hidden="true">24.</strong> Prototype Architecture</a></li><li class="chapter-item expanded "><a href="../ARCHIVE/technical-requirements.html"><strong aria-hidden="true">25.</strong> Technical requirements</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Distributed Rating Engine with wasmCloud</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/distributed-it-for-telco" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/distributed-it-for-telco/distributed-rating-doc/edit/main/src/STUDIES/migration-towards-wasmv1.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="migration-towards-wasm-v1-and-wasi-component-model"><a class="header" href="#migration-towards-wasm-v1-and-wasi-component-model">Migration towards wasm v1 and wasi component model</a></h1>
<h2 id="objectives"><a class="header" href="#objectives">Objectives:</a></h2>
<pre><code>1- explore the changes to the wasm echo-system after thr release of wasm 1.0 and adopting the component model and it tools
2- suggest a strategy for migrating the existing code to the latest version of wasm
3- attempt to make the migrated app compatible to and standard wasm standard runtime
</code></pre>
<h2 id="poc-approach"><a class="header" href="#poc-approach">POC approach:</a></h2>
<ul>
<li>The initial goal was to try create a very basic use case based on the rating agent old scenarios
<ul>
<li>[wasm-http-capability]-&gt;[**http-listener]-&gt;[**rating-agent]-&gt;[key-value-capability (redis)]</li>
<li>initial plan was not to target any wasm specific platform and use the standardized runtime (wasmtime) since it should be a reference to all platforms</li>
<li>suggested steps for dev:
<ol>
<li>migrate the interface definitions from old "smithy IDL" to the new standard "wit IDL"</li>
<li>create a simple http server (as an initial seed for an API gateway) as wasm component which implements wasi/http interface</li>
<li>create a wasm component with basic rating-agent logic</li>
<li>the rating agent should call the key-value store with an instnace of wasi/keyvalue interface</li>
<li>call the rating agent from the http server</li>
</ol>
</li>
<li>Challenges and resolutions:
<ol>
<li>Smithy IDL and WIT IDL have a few in common, and currently there are no tools to automate the migration. we had to write the interface manually  =&gt; This is a one-time issue and shall impose no concern in the future development as all old interfaces are already migrated</li>
<li>Managing WIT dependencies is not mature, even using tooll such as wit-deps, as all dependencies must be included inside the project directory.</li>
<li>WIT IDL , and wit-bindgen (the tool responsible for creating language specific interfaces) are still missing features that can be (and was in our case) criritcal, like defining serializable entities
<ul>
<li>The current workaround for this was to copy all interface definitions into a duplicate definitions with implement both mapping functionalities to oiriginal entities and also serialization behavior</li>
<li>Despite being currently the most realistic solution, it carries many drawbacks, as any changes in the wit files will demand a repetion for such task for the modified entities, which is not a best practice</li>
</ul>
</li>
<li>An attempt to use javascript as an alternative to rust for developing one of the components, however the tools available that support languages other than rust are somehow behind the maurity level of those for rust. We had to switch back to rust</li>
<li>[Blocker] At the current time of writing this document, most <strong>"wasi"</strong> interfaces are in draft phase and have no reference implementation for wasmtime, including <strong>0wasi/keyvalue</strong>, which currently only implemented im-memeory store. We attempted to create an implementation on our own, without success. That is why we were forced to switch back to use wasmcloud runtime and tooling.</li>
<li>developing for wasmcloud, has a significant divergence from developing for the standard wasm runtime, and sometimes demands using wasmcloud specific dependencies</li>
</ol>
</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ADR/ard001-monorepo_code_organization.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../HOW-TO/kickstart.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ADR/ard001-monorepo_code_organization.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../HOW-TO/kickstart.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
